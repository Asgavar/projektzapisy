language: python
python:
  - "3.6"

env:
  global:
    - REVIEWDOG_VERSION="0.9.11"

addons:
  apt:
    sources:
      - sourceline: 'deb http://dl.yarnpkg.com/debian/ stable main'
        key_url: 'http://dl.yarnpkg.com/debian/pubkey.gpg'
    packages:
      - yarn
services:
  - postgresql

install:
  - pip install -r zapisy/requirements.test.txt
  # Installs Reviewdog to comment linting errors on Github Pull Requests.
  - mkdir -p ~/bin/ && export export PATH="~/bin/:$PATH"
  - curl -fSL https://github.com/haya14busa/reviewdog/releases/download/$REVIEWDOG_VERSION/reviewdog_linux_amd64 -o ~/bin/reviewdog && chmod +x ~/bin/reviewdog
  # Installs Yarn/NPM dependencies.
  - cd zapisy && yarn && cd ..
  # Builds assets.
  - cd zapisy && yarn build && cd ..

before_script:
  - psql -c 'CREATE DATABASE fereol_test;' -U postgres
  - mv env/.env_travis env/.env
  - mkdir zapisy/logs

# Run scripts specified in Jobs rather than one global script.
script: true

jobs:
  include:
    - stage: lint
    - script: flake8 --statistics --ignore=E265,E501,F401,F841 --exclude=node_modules,*migrations --max-line-length 120 . | reviewdog -f pep8 -reporter=github-pr-check

    - stage: test
    - script: cd zapisy && python manage.py test apps.news.tests --nomigrations
    - script: cd zapisy && python manage.py test apps.schedule --nomigrations
    - script: cd zapisy && python manage.py test apps.enrollment.courses --nomigrations
    - script: cd zapisy && python manage.py test apps.enrollment.records.tests --nomigrations
    - script: cd zapisy && python manage.py test apps.grade.poll --nomigrations
    - script: cd zapisy && python manage.py test apps.users --nomigrations

cache:
- pip
- yarn