version: 2
jobs:
  setup:
    docker:
      - image: circleci/python:3.6.5-stretch-node-browsers
    steps:
      - checkout
      - run: sudo apt-get install -y postgresql postgresql-contrib
      - run: sudo bash env/postgre_setup.sh
      - run: sudo pip install --upgrade pip
      - run: sudo pip install --upgrade setuptools
      - run: sudo pip install -r zapisy/requirements.test.txt
      - run: pip freeze
      - run: sudo npm install -g npm
      - run: sudo npm install -g yarn
      - run: cd zapisy && sudo ./npm.sh
      - run: mv env/.env_circleci env/.env
      - run: mkdir zapisy/logs zapisy/static
      - run: cd zapisy && NODE_PATH=/webpack_modules/node_modules yarn build
      - run: cd zapisy && python manage.py collectstatic --noinput
  test:
    docker:
      - image: circleci/python:3.6.5-stretch-node-browsers
    steps:
      - checkout
      - run: cd zapisy && sudo coverage run manage.py test apps.news.tests --nomigrations
      - run: cd zapisy && sudo coverage run manage.py test apps.schedule --nomigrations
      - run: cd zapisy && sudo coverage run manage.py test apps.enrollment.courses --nomigrations
      - run: cd zapisy && sudo coverage run manage.py test apps.enrollment.records.tests --nomigrations
      - run: cd zapisy && sudo coverage run manage.py test apps.grade.poll --nomigrations
      - run: cd zapisy && sudo coverage run manage.py test apps.users --nomigrations
      - run: cd zapisy && sudo coverage run manage.py test test_app --nomigrations
      - run: cd zapisy && sudo coverage html
      - store_artifacts:
          path: zapisy/htmlcov
workflows:
  version: 2
  build_and_test:
    jobs:
      - setup
      - test
        requires:
          - build
