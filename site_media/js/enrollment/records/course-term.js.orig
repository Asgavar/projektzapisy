/**
 * Model terminu przedmiotu, do wyświetlenia w widoku przedmiotu.
 */

if (!Fereol.Enrollment)
	Fereol.Enrollment = new Object();

Fereol.Enrollment.CourseTerm = function()
{
	this.id = null;

	this.isEnrolled = false; // czy student jest zapisany
	this.isQueued = false; // czy jest "w kolejce"
	this.queuePriority = null; // jeżeli jest w kolejce, to jaki ma priorytet

	this.groupLimit = null;
	this.enrolledCount = null;
	this.queuedCount = null;

<<<<<<< HEAD
	this.schedule = null;
	this.course = null; // SchedulePrototype.PrototypeCourse

	this.classroom = null;
	this.teacher = null;
	this.type = null;
};

Fereol.Enrollment.CourseTerm.groupTypes =
=======
	this._queuePrioritySetURL = null;
};

Fereol.Enrollment.SubjectTerm.fromHTML = function(container)
>>>>>>> 8eb88e21880183f29d7f5d21d91e142a5698a9ca
{
	container.assertOne();

<<<<<<< HEAD
Fereol.Enrollment.CourseTerm.byGroups = {};

Fereol.Enrollment.CourseTerm.prototype.isEnrolledOrQueued = function()
{
	return this.isEnrolled || this.isQueued;
}

Fereol.Enrollment.CourseTerm.fromJSON = function(json)
{
	var sterm = new Fereol.Enrollment.CourseTerm();
	var raw = $.parseJSON(json)

	sterm.id = raw.id.castToInt();
	sterm.groupID = raw.group.castToInt();
	sterm.scheduleTerm = new Schedule.Term(
		raw.day.castToInt() - 1,
		new Schedule.Time(raw.start_time[0].castToInt(), raw.start_time[1].castToInt()),
		new Schedule.Time(raw.end_time[0].castToInt(), raw.end_time[1].castToInt()),
		sterm.container
	);
	sterm.scheduleTerm.onResize = function(isFullSize)
	{
		sterm._onResize(isFullSize);
	};

	sterm.classroom = raw.classroom.castToInt();
	sterm.teacher = raw.teacher;
	sterm.type = raw.group_type.castToInt();

	if (!Fereol.Enrollment.CourseTerm.byGroups[sterm.groupID])
		Fereol.Enrollment.CourseTerm.byGroups[sterm.groupID] = [];
	Fereol.Enrollment.CourseTerm.byGroups[sterm.groupID].push(sterm);
=======
	var sterm = new Fereol.Enrollment.SubjectTerm();
	sterm._container = container;

	sterm.id = container.find('input[name=group-id]').assertOne().attr('value').
		castToInt();
	sterm.type = container.parent().parent().parent().
		children('input[name=tutorial-type]').assertOne().attr('value').castToInt();

	sterm._groupLimitCell = container.find('td.termLimit').assertOne();
	sterm._enrolledCountCell = container.find('td.termEnrolledCount').
		assertOne();
	sterm._queuedCountCell = container.find('td.termQueuedCount').assertOne();

	sterm.groupLimit = sterm._groupLimitCell.text().castToInt();
	sterm.enrolledCount = sterm._enrolledCountCell.text().castToInt();
	sterm.queuedCount = sterm._queuedCountCell.text().castToInt();
	sterm.isEnrolled = container.find('input[name=is-signed-in]').assertOne().
		attr('value').castToBool();

	if (!Fereol.Enrollment.SubjectTerm._setEnrolledURL)
		Fereol.Enrollment.SubjectTerm._setEnrolledURL =
			$('input[name=ajax-set-enrolled-url]').assertOne().attr('value');

	var priorityCell = container.find('td.priority').assertOne();
	sterm._queuePrioritySetURL = priorityCell.
		children('input[name=ajax-priority-url]').assertOne().attr('value');
	if (priorityCell.children('form').length > 0)
	{
		sterm.isQueued = true;
		sterm.queuePriority = priorityCell.children('span').assertOne().text().
			castToInt();
	}
>>>>>>> 8eb88e21880183f29d7f5d21d91e142a5698a9ca

	return sterm;
};

<<<<<<< HEAD
Fereol.Enrollment.CourseTerm.prototype.assignSchedule = function(schedule)
{
	this.schedule = schedule;
	this._updateVisibility();
};

Fereol.Enrollment.CourseTerm.prototype._updateVisibility = function()
{
	var self = this;

	if (!this._containerReady)
	{
		this._containerReady = true;

		$.create('span', {className: 'name'}).text(this.course.shortName).
			attr('title', this.course.name).appendTo(this.container);
		this._teacherLabel = $.create('span', {className: 'teacher'}).text(this.teacher).
			appendTo(this.container);
		this._typeLabel = $.create('span', {className: 'type'}).
			appendTo(this.container).attr('title',
			Fereol.Enrollment.CourseTerm.groupTypes[this.type][0]);

		this._classroomLabel = $.create('span', {className: 'classroom'}).
			appendTo(this.container);
		if (this.classroom)
			this._classroomLabel.text('s. ' + this.classroom);

		this._controlsBox = $.create('div', {className: 'controls'}).
			appendTo(this.container).css('display', 'none');
=======
/**
 * Zamienia zwykłe kontrolki (np. przyciski zapisywania) w ajax-owe.
 */
Fereol.Enrollment.SubjectTerm.prototype.convertControlsToAJAX = function()
{
	var self = this;

	var setEnrolledForm = this._container.find('.setEnrolled').assertOne();
>>>>>>> 8eb88e21880183f29d7f5d21d91e142a5698a9ca

	// Opera nie potrafi łamać wierszy w input[type=button]
	if ($.browser.opera)
	{
		this._setEnrolledButton = $.create('button', {
			className: 'setEnrolledButton'
		}).insertAfter(setEnrolledForm);
		this._setEnrolledButtonAlternative = true;
	}
	else
	{
		this._setEnrolledButton = $.create('input', {
			type: 'button',
			className: 'setEnrolledButton'
		}).insertAfter(setEnrolledForm);
		this._setEnrolledButtonAlternative = false;
	}

<<<<<<< HEAD
Fereol.Enrollment.CourseTerm.prototype._updateControls = function()
{
	var self = this;
	
	if (!this._controlsReady)
=======
	setEnrolledForm.remove();
	this._setEnrolledButton.click(function()
>>>>>>> 8eb88e21880183f29d7f5d21d91e142a5698a9ca
	{
		MessageBox.clear();
		self.setEnrolled(self._setEnrolledAction);
	});

	var priorityCell = this._container.find('td.priority').assertOne();
	priorityCell.empty();
	this._prioritySelector = $.create('select').appendTo(priorityCell);
	for (var i = 1; i <= 10; i++)
	{
		var priorityOption = $.create('option', {value: i}).text(i);
		if (i === this.queuePriority)
			priorityOption.attr('selected', 'selected');
		this._prioritySelector.append(priorityOption);
	}
	this._prioritySelector.change(function()
	{
		MessageBox.clear();
		self.changePriority(self._prioritySelector.attr('value').
			castToInt());
	});

<<<<<<< HEAD
	this._pinUnpinButton.css({
		backgroundPosition: this.isPinned ? '-12px -12px' : '0 -12px',
		display: this.isEnrolledOrQueued() ? 'none' : ''
	}).attr('title', this.isPinned ? 'odepnij od planu' : 'przypnij do planu');
	this._signInOutButton.css({
		backgroundPosition: this.isEnrolledOrQueued() ? '-12px 0' : '0 0',
		display: this.course.isRecordingOpen ? '' : 'none'
	}).attr('title', this.isEnrolledOrQueued() ? 'wypisz się' +
		(this.isQueued ? ' z kolejki' : '') : 'zapisz się');
	this._controlsEmpty = this.isEnrolledOrQueued() &&
		!this.course.isRecordingOpen;
};

Fereol.Enrollment.CourseTerm.prototype._onResize = function(isFullSize)
=======
	this.refreshView();
};

/**
 * Odświeża wiersz terminu na podstawie danych z modelu javascriptowego.
 */
Fereol.Enrollment.SubjectTerm.prototype.refreshView = function()
>>>>>>> 8eb88e21880183f29d7f5d21d91e142a5698a9ca
{
	this._prioritySelector.toggle(this.isQueued);
	this._container.toggleClass('signed', this.isEnrolled);

	this._setEnrolledAction = null;
	var newEnrolledButtonLabel = null;
	if (this.isEnrolled)
	{
		this._setEnrolledAction = false;
		newEnrolledButtonLabel = 'wypisz';
	}
	else if (!this.isFull())
	{
		this._setEnrolledAction = true;
		newEnrolledButtonLabel = 'zapisz'; //TODO: przenieś
	}
	else if (this.isQueued)
	{
		this._setEnrolledAction = false;
		newEnrolledButtonLabel = 'wypisz z kolejki';
	}
	else
	{
		this._setEnrolledAction = true;
		newEnrolledButtonLabel = 'zapisz do kolejki';
	}

<<<<<<< HEAD
	this._typeLabel.text(Fereol.Enrollment.CourseTerm.
		groupTypes[this.type][isFullSize?0:1]).css({
		top: (this._typeLabel.parent().innerHeight() -
			this._typeLabel.height() -
			CLASSROOM_PADDING) + 'px'
	});
=======
	if (this._setEnrolledButtonAlternative)
		this._setEnrolledButton.text(newEnrolledButtonLabel);
	else
		this._setEnrolledButton.attr('value', newEnrolledButtonLabel);
>>>>>>> 8eb88e21880183f29d7f5d21d91e142a5698a9ca

	this._enrolledCountCell.text(this.enrolledCount);
	this._queuedCountCell.text(this.queuedCount);
};

<<<<<<< HEAD
Fereol.Enrollment.CourseTerm.prototype.setPrototyped = function(prototyped)
=======
/**
 * @return true, jeżeli grupa jest pełna
 */
Fereol.Enrollment.SubjectTerm.prototype.isFull = function()
>>>>>>> 8eb88e21880183f29d7f5d21d91e142a5698a9ca
{
	if (this.groupLimit === null ||
		this.enrolledCount === null)
		throw new Error('NullPointerException');
	return this.groupLimit <= this.enrolledCount;
};

<<<<<<< HEAD
Fereol.Enrollment.CourseTerm.prototype.setPinned = function(pinned)
=======
/**
 * Zmienia priorytet grupy.
 *
 * @param newPriority nowy priorytet (1-10)
 */
Fereol.Enrollment.SubjectTerm.prototype.changePriority = function(newPriority)
>>>>>>> 8eb88e21880183f29d7f5d21d91e142a5698a9ca
{
	var self = this;
	this._prioritySelector.attr('disabled', true);
	if (newPriority < 1 || newPriority > 10)
		throw new Error('Nieprawidłowy priorytet do ustawienia');
	
	$.post(this._queuePrioritySetURL, {
			csrfmiddlewaretoken: $.cookie('csrftoken'),
			priority: newPriority
		}, function(data)
	{
		var result = AjaxMessage.fromJSON(data);
		if (result.isSuccess())
			self._prioritySelector.attr('disabled', false);
		else
			result.displayMessageBox();
	}, 'json');
};

<<<<<<< HEAD
Fereol.Enrollment.CourseTerm.prototype.setEnrolled = function(enrolled)
=======
/**
 * Zapisuje lub wypisuje użytkownika do/z grupy lub kolejki (w zależności od
 * wolnych miejsc.
 *
 * Założenie: zmiany limitów grup odbywają się rzadko. Zmiana taka może
 * spowodować operowanie na nieświeżych danych, np. użytkownik może obserwować
 * nieprawidłowe liczniki grup. Na przykład, jeżeli przy próbie zapisania się
 * do grupy (w której było 10 zajętych miejsc na 20 w sumie) zostaną
 * zmniejszone w niej limity (do równo 10), użytkownik zamiast stanu 10/10
 * ujrzy 20/20 (i siebie w kolejce). Po odświeżeniu zobaczy prawidłowy stan.
 *
 * Zawsze jedak akcja "zapisania" zapisze go do grupy lub kolejki, akcja
 * "wypisania" analogicznie wypisze. Akcja "zapisania", jeżeli zapisze go do
 * kolejki, NIE wypisze z grupy, niezależnie od etykiety przycisku (która może
 * brzmieć "przepisz do innej grupy").
 *
 * @param enroll true, jeżeli zapisać; false aby wypisać
 */
Fereol.Enrollment.SubjectTerm.prototype.setEnrolled = function(enroll)
>>>>>>> 8eb88e21880183f29d7f5d21d91e142a5698a9ca
{
	if (!Fereol.Enrollment.SubjectTerm._setLoading(true))
		return;

	var self = this;
<<<<<<< HEAD
	this._updateControls();

	if (!this.course.isRecordingOpen)
		throw new Error('Zapisy na ten przedmiot są zamknięte');
=======
	enroll = !!enroll;
>>>>>>> 8eb88e21880183f29d7f5d21d91e142a5698a9ca

	$.post(Fereol.Enrollment.SubjectTerm._setEnrolledURL, {
		csrfmiddlewaretoken: $.cookie('csrftoken'),
		group: this.id,
		enroll: enroll
	}, function(data)
	{
		var result = AjaxMessage.fromJSON(data);
		self._isLoading = false;
		if (self.isEnrolled)
		{
			self.isEnrolled = false;
			self.enrolledCount--;
		}
		if (self.isQueued)
		{
			self.isQueued = false;
			self.queuedCount--;
		}
		if (result.isSuccess())
		{
			if (self.isEnrolled != enroll)
			{
				self.isEnrolled = enroll;
				self.enrolledCount += (enroll ? 1 : -1);
			}
			self.isQueued = false;
			if (enroll)
			{
				// zaznaczanie innych grup tego samego typu jako "nie zapisane"
<<<<<<< HEAD
				self.course.terms.forEach(function(e)
=======
				SubjectView._termsList.forEach(function(e)
>>>>>>> 8eb88e21880183f29d7f5d21d91e142a5698a9ca
				{
					if (e.id == self.id || e.type != self.type)
						return;
					if (e.isEnrolled)
					{
						e.isEnrolled = false;
						e.enrolledCount--;
					}
					e.refreshView();
				});

				// zaznaczanie powiązanych jako "zapisane"
				result.data.forEach(function(alsoEnrolledID)
				{
					if (alsoEnrolledID == self.id)
						return;
<<<<<<< HEAD
					Fereol.Enrollment.CourseTerm.byGroups[e].forEach(function(alsoEnrolledTo)
=======
					var alsoEnrolled = SubjectView._termsMap[alsoEnrolledID];
					if (!alsoEnrolled.isEnrolled)
>>>>>>> 8eb88e21880183f29d7f5d21d91e142a5698a9ca
					{
						alsoEnrolled.isEnrolled = true;
						alsoEnrolled.enrolledCount++;
					}
					alsoEnrolled.refreshView();
				})
			}
		}
		else if (result.code == 'Queued' || result.code == 'AlreadyQueued')
		{
			self.isQueued = true;
			self.queuedCount++;
			if (self.enrolledCount < self.groupLimit)
				self.enrolledCount = self.groupLimit;
			result.displayMessageBox();
		}
		else
			result.displayMessageBox();
		self.refreshView();
		Fereol.Enrollment.SubjectTerm._setLoading(false);
	}, 'json');
};

<<<<<<< HEAD
Fereol.Enrollment.CourseTerm.prototype.toString = function()
=======
/**
 * Włącza lub wyłącza tryb komunikacji z serwerem. W tym trybie może być tylko
 * jeden "wątek".
 *
 * @param loading true, jeżeli włączyć
 * @return true, jeżeli zakończono powodzeniem
 */
Fereol.Enrollment.SubjectTerm._setLoading = function(loading)
>>>>>>> 8eb88e21880183f29d7f5d21d91e142a5698a9ca
{
	loading = !!loading;
	if (loading && Fereol.Enrollment.SubjectTerm._isLoading)
		return false;
	Fereol.Enrollment.SubjectTerm._isLoading = loading;
	$('input.setEnrolledButton').attr('disabled', loading);
	return true;
};

Fereol.Enrollment.SubjectTerm.prototype.toString = function()
{
	return 'SubjectTerm';
}
