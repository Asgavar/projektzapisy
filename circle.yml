general:
  build_dir: zapisy

machine:
  python:
    version: 3.6.2
  node:
    version: 9.20

dependencies:
  override:
    # CircleCI automatically caches node_modules which is just stupid
    # as we can and do have different versions of the same packages between
    # branches
    # It seems you can't disable this, see https://discuss.circleci.com/t/how-to-always-rebuild-without-npm-cache/1196
    - rm -rf node_modules/
    # For good measure also clear any other crap they might have restored from the cache
    - git clean -nd
    - git clean -fd
    - pip --version
    - pip install -U setuptools
    - pip install --upgrade pip
    - pip install -r requirements.test.txt
    - npm i -g npm  # Make sure we're using the latest npm version
    - npm --version
    - npm root -g
    - npm i -g yarn
    - which yarn
    - yarn --version
    - yarn
    - pip freeze

test:
  pre:
    - mv ../env/.env_circleci ../env/.env
  override:
    - mkdir logs
    - yarn build
    - mkdir static
    - python manage.py collectstatic --noinput
    # - python manage.py test test_app --nomigrations
    # - coverage run manage.py test test_app
    - coverage run manage.py test test_app --nomigrations
    - coverage run manage.py test apps.news.tests --nomigrations
    - coverage run manage.py test apps.schedule --nomigrations
    - coverage run manage.py test apps.enrollment.courses --nomigrations
    - coverage run manage.py test apps.enrollment.records.tests --nomigrations
    - coverage run manage.py test apps.grade.poll --nomigrations
    - coverage run manage.py test apps.users --nomigrations
  post:
    - coverage html -d $CIRCLE_ARTIFACTS
